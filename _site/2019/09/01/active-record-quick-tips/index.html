<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>

  <title>ActiveRecord - Quick Tips</title>
  <meta name='description' content="I will use the data from an dump with 100.000 registers">
  <link rel='canonical' href="http://localhost:4000/2019/09/01/active-record-quick-tips/">
  <link rel='alternate' type='application/rss+xml' title='Sapienza' href="http://localhost:4000/feed.xml">

  <style>
    

    html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}/*! normalize.css v5.0.0 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,footer,header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figcaption,figure,main{display:block}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:rgba(0,0,0,0);-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}dfn{font-style:italic}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:sans-serif;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,html [type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{display:inline-block;vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details,menu{display:block}summary{display:list-item}canvas{display:inline-block}template{display:none}[hidden]{display:none}body,h1,h2,h3,h4,h5,h6,blockquote,p,pre,dl,dd,ol,ul,figure,hr,fieldset,legend{margin:0;padding:0}li>ol,li>ul{margin-bottom:0}table{border-collapse:collapse;border-spacing:0}address,h1,h2,h3,h4,h5,h6,blockquote,p,pre,dl,ol,ul,figure,hr,table,fieldset{margin-bottom:32px}dd,ol,ul{list-style-position:inside;margin-left:16px}@-webkit-keyframes spin{100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spin{100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.icon{position:relative;display:inline-block;width:25px;height:25px;overflow:hidden;fill:currentColor}.icon__cnt{width:100%;height:100%;background:inherit;fill:inherit;pointer-events:none;transform:translateX(0);-ms-transform:translate(0.5px, -0.3px)}.icon--m{width:50px;height:50px}.icon--l{width:100px;height:100px}.icon--xl{width:150px;height:150px}.icon--xxl{width:200px;height:200px}.icon__spinner{position:absolute;top:0;left:0;width:100%;height:100%}.icon--ei-spinner .icon__spinner,.icon--ei-spinner-2 .icon__spinner{-webkit-animation:spin 1s steps(12) infinite;animation:spin 1s steps(12) infinite}.icon--ei-spinner-3 .icon__spinner{-webkit-animation:spin 1.5s linear infinite;animation:spin 1.5s linear infinite}.icon--ei-sc-facebook{fill:#3b5998}.icon--ei-sc-github{fill:#333}.icon--ei-sc-google-plus{fill:#dd4b39}.icon--ei-sc-instagram{fill:#3f729b}.icon--ei-sc-linkedin{fill:#0976b4}.icon--ei-sc-odnoklassniki{fill:#ed812b}.icon--ei-sc-skype{fill:#00aff0}.icon--ei-sc-soundcloud{fill:#f80}.icon--ei-sc-tumblr{fill:#35465c}.icon--ei-sc-twitter{fill:#55acee}.icon--ei-sc-vimeo{fill:#1ab7ea}.icon--ei-sc-vk{fill:#45668e}.icon--ei-sc-youtube{fill:#e52d27}.icon--ei-sc-pinterest{fill:#bd081c}.icon--ei-sc-telegram{fill:#08c}.highlight{margin:0;background:#fff}.highlighter-rouge .highlight{background:#fafafa}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086b3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:teal}.highlight .ni{color:purple}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}body{color:#323232;font-size:19px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";line-height:32px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}*::selection{color:#fff;background:#00a0ff}a{text-decoration:none;color:#323232;transition:.4s}a:hover,a:active,a:focus{text-decoration:underline}img{display:block;max-width:100%;font-style:italic}hr{height:1px;margin:32px 0;border:0;background-color:#e9eff3}h1,h2,h3,h4,h5,h6{font-weight:inherit;line-height:initial;font-weight:600}h1{font-size:36px}h2{font-size:28px}h3{font-size:24px}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px}blockquote{padding-left:16px;border-left:3px solid #2b5f72}pre,code{font-family:Courier,monospace;background-color:#fafafa}pre{overflow:auto;padding:32px;margin-bottom:16px;font-size:16px;line-height:25px;white-space:pre-wrap;word-wrap:break-word}li code,p code{padding:4px 8px}input[type=text],input[type=tel],input[type=number],input[type=email],select,textarea{width:100%;padding:16px;border:1px solid #e9eff3;border-radius:0;outline:none;background-color:#fff;font-size:14px;appearance:none;transition:.4s}input[type=text]:hover,input[type=text]:active,input[type=text]:focus,input[type=tel]:hover,input[type=tel]:active,input[type=tel]:focus,input[type=number]:hover,input[type=number]:active,input[type=number]:focus,input[type=email]:hover,input[type=email]:active,input[type=email]:focus,select:hover,select:active,select:focus,textarea:hover,textarea:active,textarea:focus{border:1px solid #323232}.o-grid{margin:0 auto;display:flex;flex-wrap:wrap;max-width:700px}.o-grid:after{content:"";display:table;clear:both}.o-grid .o-grid{margin-right:-16px;margin-left:-16px;padding:0}.o-grid--full{max-width:100vw}.o-grid__col{float:left;padding-right:16px;padding-left:16px}.o-grid__col--1-4-s{width:25%}.o-grid__col--1-3-s{width:33.3333333333%}.o-grid__col--2-4-s{width:50%}.o-grid__col--3-4-s{width:75%}.o-grid__col--4-4-s{width:100%}@media(min-width: 46.25em){.o-grid__col--1-4-m{width:25%}.o-grid__col--1-3-m{width:33.3333333333%}.o-grid__col--2-4-m{width:50%}.o-grid__col--3-4-m{width:75%}}@media(min-width: 61.25em){.o-grid__col--1-4-l{width:25%}.o-grid__col--1-3-l{width:33.3333333333%}.o-grid__col--2-4-l{width:50%}.o-grid__col--3-4-l{width:75%}}.o-grid__col--full{width:100%}.o-grid__col--center{margin:0 auto}.o-grid__col--end{margin-left:auto}.o-wrapper{padding:32px 0}.c-off-canvas-container{display:flex;min-height:100vh;flex-direction:column}.c-off-canvas-container .o-wrapper{flex:1 0 auto}.o-plain-list{margin:0;padding:0;list-style:none}.c-header__inner{padding:16px 0;border-bottom:1px solid #e9eff3}.c-header__icon{vertical-align:middle}.c-logo__link{font-size:19px;font-weight:900;transition:.4s}.c-logo__link:hover,.c-logo__link:active,.c-logo__link:focus{color:#00a0ff;text-decoration:none}.c-nav__item{font-size:16px}.c-nav__link{display:block;transition:.4s}.c-nav__link--current{color:#00a0ff}.home-template .c-nav__link--current:not(:hover){color:#323232}.c-nav__link:hover,.c-nav__link:active,.c-nav__link:focus{color:#00a0ff;text-decoration:none}.c-off-canvas-toggle{float:right;position:relative;top:8px;z-index:10;height:19px;width:25px;cursor:pointer}.c-off-canvas-toggle__icon{position:absolute;left:0;height:1px;width:25px;background:#323232;cursor:pointer}.c-off-canvas-toggle__icon:before,.c-off-canvas-toggle__icon:after{content:"";display:block;height:100%;background-color:inherit;transition:.4s}.c-off-canvas-toggle__icon:before{transform:translateY(16px)}.c-off-canvas-toggle__icon:after{transform:translateY(7px)}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon{height:2px;background-color:rgba(0,0,0,0)}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:before,.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:after{position:relative;visibility:visible;background:#323232}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:before{top:11px;transform:rotate(-45deg)}.c-off-canvas-toggle--close .c-off-canvas-toggle__icon:after{top:9px;transform:rotate(45deg)}.c-off-canvas-toggle--close{top:0;float:none;display:block;margin-left:auto}html,body{overflow-x:hidden}.c-off-canvas-content{position:fixed;top:0;right:0;width:300px;height:100%;padding:24px 32px;background-color:#fff;transform:translate3d(300px, 0, 0)}.c-off-canvas-container{transform:translate3d(0, 0, 0);transition:transform .4s cubic-bezier(0.16, 0.68, 0.43, 0.99)}.c-off-canvas-container.is-active{transform:translate3d(-300px, 0, 0)}.c-off-canvas-container.is-active:after{position:fixed;top:0;right:0;bottom:0;left:0;content:"";background-color:rgba(0,0,0,.2)}.c-tags a{display:inline-block;padding:4px 16px;margin:0 8px 4px 0;font-size:12px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";line-height:25px;background-color:#fafafa;transition:.4s}.c-tags a:hover,.c-tags a:active,.c-tags a:focus{text-decoration:none;background-color:#fafafa}@media(max-width: 46.24em){.c-tags{margin-bottom:22px}}.c-btn{display:inline-block;padding:8px 32px;cursor:pointer;transition:.4s;text-align:center;vertical-align:middle;white-space:nowrap;line-height:inherit;border:0;border-radius:0;color:#fff;background-color:#207cdf;font-size:16px}.c-btn:hover,.c-btn:active,.c-btn:focus{text-decoration:none;background-color:#238cf6}.c-btn--full{width:100%}.c-btn--small{padding:4px 16px}.c-post-card{display:block;padding:32px 0;word-break:break-word;border-bottom:1px solid #e9eff3}.c-post-card--first{padding-top:0}.c-post-card--last{padding-bottom:0;border-bottom:0}.c-post-card__title{margin-bottom:10px;font-size:19px;font-weight:600;transition:.4s}@media(min-width: 46.25em){.c-post-card__title{font-size:28px}}.c-post-card__excerpt{margin-bottom:10px}.c-post-card__date{display:block;color:#2b5f72;direction:ltr;font-size:12px;font-weight:600;line-height:22px;text-transform:uppercase}.c-post-card:hover{color:#323232;text-decoration:none}.c-post-card:hover .c-post-card__title{color:#00a0ff}.c-pagination{text-transform:uppercase;transition:.4s}.c-pagination:hover,.c-pagination:active,.c-pagination:focus{color:#00a0ff;text-decoration:none}.c-pagination__text{position:relative;font-size:14px;letter-spacing:2px}.c-pagination__text--prev{left:-16px}.c-pagination__text--next{right:-16px}.c-pagination__icon{vertical-align:text-top}.c-pagination__icon--prev{left:-8px}.c-pagination__icon--next{right:-8px}.c-post{margin:0 auto;max-width:740px}.c-post__title{font-size:24px;margin-bottom:16px}@media(min-width: 46.25em){.c-post__title{font-size:28px}}.c-post__date{position:relative;padding-top:16px;display:block;text-align:center;margin-bottom:16px;font-size:14px;font-weight:600;line-height:22px;color:#2b5f72}.c-post__date:after{position:absolute;content:"";top:0;left:50%;height:1px;width:64px;background:#fafafa;transform:translateX(-50%)}.c-post__image{margin:0 auto 16px}.c-content a:not(.c-btn){text-decoration:underline;text-decoration-skip:ink}.c-content a:not(.c-btn):hover,.c-content a:not(.c-btn):active,.c-content a:not(.c-btn):focus{color:#00a0ff}.twitter-tweet,.fluid-width-video-wrapper{margin-bottom:16px !important}.c-social-nav__item{display:inline-block}.c-social-nav__icon{fill:#323232;vertical-align:middle;transition:.4s}.c-social-nav__icon:hover,.c-social-nav__icon:active,.c-social-nav__icon:focus{fill:#00a0ff}.c-footer{padding:32px 0;background-color:#fafafa}.u-hidden{display:none}.u-hidden-visually{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.u-font-medium{font-size:16px;line-height:25px}.u-font-small{font-size:14px;line-height:22px}.u-font-tiny{font-size:12px;line-height:19px}.u-text-left{text-align:left}.u-text-right{text-align:right}.u-text-center{text-align:center}.u-text-justify{text-align:justify}.u-inline{display:inline}.u-block{display:block}.u-inline-block{display:inline-block}.u-left{float:left}.u-right{float:right}.u-clearfix:after{content:"";display:table;clear:both}
  </style>
</head>

<body>

  <!-- Google Analytics Code -->

  <div class='js-off-canvas-container c-off-canvas-container'>
    <header class='c-header'>

  <div class='o-grid'>
    <div class='o-grid__col o-grid__col--full'>
      <div class='c-header__inner'>

        <div class='o-grid'>
          <div class='o-grid__col o-grid__col--3-4-s'>
            <div class='c-logo u-text-left'>
              <a class='c-logo__link' href='/'>Sapienza</a>
            </div>
          </div>

          <div class='o-grid__col o-grid__col--1-4-s'>
            <label class='js-off-canvas-toggle c-off-canvas-toggle' aria-label='Toggle navigation'>
              <span class='c-off-canvas-toggle__icon'></span>
            </label>
          </div>

          <div class='o-grid__col o-grid__col--1-4-s'>
            <div class='c-off-canvas-content'>
              <label class='js-off-canvas-toggle c-off-canvas-toggle c-off-canvas-toggle--close'>
                <span class='c-off-canvas-toggle__icon'></span>
              </label>

              <ul class='c-nav o-plain-list '>
                
  

  
    
      <li class='c-nav__item' role='presentation'>
        <a class='c-nav__link' href='/about.html'>About</a>
      </li>
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</header>

    


  <meta itemprop='og:image' content='http://localhost:4000/images/posts/rails.jpg'>


<div class='o-wrapper'>

  <div class='o-grid'>
    <div class='o-grid__col'>
      <article class='c-post' itemscope itemtype='http://schema.org/BlogPosting'>

        <h1 class='c-post__title u-text-center'>ActiveRecord - Quick Tips</h1>

        <time class='c-post__date' datetime='2019-09-01T00:00:00-03:00' itemprop='datePublished'>01 Sep 2019</time>

        <div class='c-content' itemprop='articleBody'>
          
  <img src='/images/posts/rails.jpg' class='c-post__image' alt='ActiveRecord - Quick Tips'>


          <p>I will use the data from an dump with 100.000 registers</p>

<h2 id="pluck-vs-map">pluck vs. map</h2>

<p>Map is useful for arrays, and that is it. Rails select all columns to instantiate an object for each row</p>

<p>Pluck delegates that job to the SQL, which turns the process way much faster and effective.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">ms</span> <span class="p">{</span> <span class="no">Purchase</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="mf">23967.25999999944</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ms</span> <span class="p">{</span> <span class="no">Purchase</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="mf">425.65599999943515</span>
</code></pre></div></div>

<p>If you already had an array with the objects, maybe it is better to use the map than touch the database again</p>

<h2 id="uniq">uniq</h2>

<p>Order makes difference</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">ms</span> <span class="p">{</span> <span class="no">Purchase</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">).</span><span class="nf">uniq</span> <span class="p">}</span>
 <span class="o">=&gt;</span> <span class="mf">1645.4709999998158</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ms</span> <span class="p">{</span> <span class="no">Purchase</span><span class="p">.</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span> <span class="p">}</span>
 <span class="o">=&gt;</span> <span class="mf">446.65100000020175</span>
</code></pre></div></div>

<p>At the first case, the pluck returns an array with an id for each row from the Purchases table, the duplicated are then filtered using the <code class="language-plaintext highlighter-rouge">Array#uniq</code></p>

<p>In the second the uniq uses the <code class="language-plaintext highlighter-rouge">ActiveRecord::QueryMethods#uniq</code> that filter directly in the SQL with DISTINCT</p>

<h1 id="find_each-vs-find_in_batches-vs-each">find_each vs. find_in_batches vs. Each</h1>

<p>For iterations over a small number of objects, using each solves it. But when the talk about thousands or millions of objects, using 
each becomes inviable taking in consideration that it loads all objects to just them iterate over it.</p>

<p>The solution is to “broke” that in blocks</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Purchase</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">confirmed: </span><span class="kp">false</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">purchase</span><span class="o">|</span>
  <span class="n">purchase</span><span class="p">.</span><span class="nf">confirm!</span>
<span class="k">end</span>


<span class="no">Purchase</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">confirmed: </span><span class="kp">false</span><span class="p">).</span><span class="nf">find_in_batches</span> <span class="k">do</span> <span class="o">|</span><span class="n">group</span><span class="o">|</span>
  <span class="n">group</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">purchase</span><span class="o">|</span> <span class="n">purchase</span><span class="p">.</span><span class="nf">confirm!</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Purchase</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">confirmed: </span><span class="kp">false</span><span class="p">).</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">puchase</span><span class="o">|</span> 
  <span class="n">purchase</span><span class="p">.</span><span class="nf">confirm!</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">each</code> will block the row UNTIL gets it done, it can be a trouble if we are talking about a big table or if the table is used in other scenarios as well</p>

<p>Using the <code class="language-plaintext highlighter-rouge">find_in_batches</code>, it will make the queries by blocks of 1000 ( default, but can be changed ), in other words it will no longer block the table to other queries</p>

<p><code class="language-plaintext highlighter-rouge">find_each</code> is basically an shortcut for <code class="language-plaintext highlighter-rouge">find_in_batches</code> that dont use the scope of the blocks returned</p>

<h2 id="includes">includes</h2>

<p>Nice to avoid N+1 queries, since it also load the relation records</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Purchase</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:person</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">purchase</span><span class="o">|</span> <span class="n">purchase</span><span class="p">.</span><span class="nf">person</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="joins-vs-includes">joins vs includes</h2>

<p>Joins is a good one if you are just filtering through the results, not accessing the records from the relationship directly. ( It dont avoid N+1 queries )</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Purchase</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:person</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">:people</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">confirmed: </span><span class="kp">true</span><span class="p">}).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">purchase</span><span class="o">|</span> <span class="n">purchase</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
</code></pre></div></div>

<p>Otherwise, if will access the associations directly its a good one to use includes since it avoids N+1 queries</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Purchase</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:person</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">purchase</span><span class="o">|</span> <span class="n">purchase</span><span class="p">.</span><span class="nf">person</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="exists-vs-any">exists vs any</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">ms</span> <span class="p">{</span> <span class="no">Purchase</span><span class="p">.</span><span class="nf">any?</span> <span class="p">}</span>
 <span class="o">=&gt;</span> <span class="mf">31.580000009853393</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ms</span> <span class="p">{</span> <span class="no">Purchase</span><span class="p">.</span><span class="nf">exists?</span> <span class="p">}</span>
 <span class="o">=&gt;</span> <span class="mf">3.292000008514151</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">any?</code>:  accepts a block and retrieves the records in the relation with it  ( calls #to_a, calls the block, hits it with <code class="language-plaintext highlighter-rouge">Enumerable#any?</code> ), without a block its the same as <code class="language-plaintext highlighter-rouge">!empty?</code> and count the records of the relation</p>

<p>As few examples earlier, the <code class="language-plaintext highlighter-rouge">exists?</code> delegate it to the SQL setting a <code class="language-plaintext highlighter-rouge">LIMIT 1 </code> and becomes way faster.</p>

<h1 id="group-counting">Group Counting</h1>

<p>Interesting way to get the count based on attributes of the model.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Purchase</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:signed_contract</span><span class="p">).</span><span class="nf">count</span>
 <span class="o">=&gt;</span> <span class="p">{</span><span class="kp">false</span><span class="o">=&gt;</span><span class="mi">1527</span><span class="p">,</span> <span class="kp">true</span><span class="o">=&gt;</span><span class="mi">98484</span><span class="p">}</span>
</code></pre></div></div>

        </div>

        <div class='c-tags'>
          
            <a href='/tag/ruby'>ruby</a>
          
            <a href='/tag/rails'>rails</a>
          
            <a href='/tag/activerecord'>activerecord</a>
          
        </div>

      </article>

    </div>
  </div>
</div>

    <footer class='c-footer'>
  <div class='o-grid'>
    <div class='o-grid__col o-grid__col--full'>

      <ul class='o-plain-list c-social-nav u-text-center'>
        <li class='c-social-nav__item'>
          <a href='https://github.com/sap1enza' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-sc-github' data-size='s'></span>
          </a>
        </li>
        <li class='c-social-nav__item'>
          <a href='mailto:sapienzalucas@gmail.com' target='_blank'>
            <span class='c-social-nav__icon' data-icon='ei-envelope' data-size='s'></span>
          </a>
        </li>
      </ul>

    </div>
  </div>
</footer>

  </div>

  <script src="/js/jquery-3.1.1.min.js"> </script>
  <script src="/js/evil-icons.min.js">   </script>
  <script src="/js/jquery.fitvids.js">   </script>
  <script src="/js/app.js">              </script>
</body>

</html>